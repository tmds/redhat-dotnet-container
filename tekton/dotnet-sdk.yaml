apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: dotnet-sdk
  labels:
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/pipelines.minVersion: "0.19"
    tekton.dev/tags: dotnet, workspace
    tekton.dev/displayName: ".NET SDK"
spec:
  description: >-
    dotnet-sdk task runs a user-specified script that can use the .NET SDK.
  workspaces:
    - name: source
      mountPath: /workspace/source
      description: >-
        An optional workspace that allows to provide source code.
      optional: true
  params:
    - name: SCRIPT
      description: The OpenShift CLI arguments to run
      type: string
      default: "dotnet --info"
    - name: SDK_VERSION
      default: latest
      description: Tag of .NET SDK imagestream.
      type: string
    - name: DOTNET_NAMESPACE
      description: Namespace of the .NET imagestreams. Set to '$(context.taskRun.namespace)' to use the pipeline namespace.
      default: openshift
      type: string
  steps:
    - name: dotnet
      image: image-registry.openshift-image-registry.svc:5000/$(params.DOTNET_NAMESPACE)/dotnet:$(params.SDK_VERSION)
      script: |
        #!/usr/bin/env bash

        if [[ "$(workspaces.source.bound)" == "true" ]]; then
          mkdir -p ~/src
          cp -a "$(workspaces.source.path)/." ~/src
          cd ~/src
        fi

        export OpenShiftInternalRegistry="image-registry.openshift-image-registry.svc:5000"
        export OpenShiftDotnetNamespace="$(params.DOTNET_NAMESPACE)"
        export OpenShiftCurrentNamespace="$(context.taskRun.namespace)"

        # Provide a convenient way to publish to the internal OpenShift registry.
        PublishProfileFullPath=/tmp/OpenShiftContainer.pubxml
        cat >"${PublishProfileFullPath}" <<'EOF'
        <Project>
          <PropertyGroup>
            <WebPublishMethod>Container</WebPublishMethod>

            <!-- Stop the RedHat.Container package to generate a warning for specifying a base image. -->
            <NoWarn>$(NoWarn);RHCONTAINER001</NoWarn>
          </PropertyGroup>

          <Target Name="ComputeOpenShiftContainerBaseImage" BeforeTargets="ComputeContainerBaseImage">

            <Error Condition="'$(OpenShiftInternalRegistry)' == ''" Text="'OpenShiftInternalRegistry' is not set." />
            <Error Condition="'$(OpenShiftDotnetNamespace)' == ''" Text="'OpenShiftDotnetNamespace' is not set." />

            <!-- Pick the proper base image from the OpenShiftDotnetNamespace namespace. -->
            <PropertyGroup>
              <ContainerBaseImage>$(OpenShiftInternalRegistry)/$(OpenShiftDotnetNamespace)/dotnet-runtime:$(_TargetFrameworkVersionWithoutV)</ContainerBaseImage>
            </PropertyGroup>
          </Target>

          <Target Name="ComputeOpenShiftContainerConfig" BeforeTargets="ComputeContainerConfig">

            <Error Condition="'$(OpenShiftImageName)' == ''" Text="'OpenShiftImageName' is not set." />
            <Error Condition="'$(OpenShiftInternalRegistry)' == ''" Text="'OpenShiftInternalRegistry' is not set." />
            <Error Condition="'$(OpenShiftCurrentNamespace)' == ''" Text="'OpenShiftCurrentNamespace' is not set." />

            <!-- Expand OpenShiftImageName, using OpenShiftInternalRegistry and OpenShiftCurrentNamespace. -->
            <PropertyGroup Condition="$(OpenShiftImageName.IndexOf('.')) == -1 Or $(OpenShiftImageName.IndexOf('.')) &gt; $(OpenShiftImageName.IndexOf('/'))">
              <OpenShiftImageName Condition="$(OpenShiftImageName.IndexOf('/')) == -1">$(OpenShiftCurrentNamespace)/$(OpenShiftImageName)</OpenShiftImageName>
              <OpenShiftImageName>$(OpenShiftInternalRegistry)/$(OpenShiftImageName)</OpenShiftImageName>
            </PropertyGroup>

            <!-- Set SDK container tooling properties based on OpenShiftImageName. -->
            <PropertyGroup>
              <ContainerRegistry>$(OpenShiftImageName.Substring(0, $(OpenShiftImageName.IndexOf('/'))))</ContainerRegistry>
              <ContainerRepository>$(OpenShiftImageName.Substring($([MSBuild]::Add($(OpenShiftImageName.IndexOf('/')), 1))))</ContainerRepository>
              <ContainerImageTag>latest</ContainerImageTag>
              <ContainerImageTag Condition="$(ContainerRepository.Contains(':'))">$(ContainerRepository.Substring($([MSBuild]::Add($(ContainerRepository.IndexOf(':')), 1))))</ContainerImageTag>
              <ContainerRepository Condition="$(ContainerRepository.Contains(':'))">$(ContainerRepository.Substring(0, $(ContainerRepository.LastIndexOf(':'))))</ContainerRepository>
            </PropertyGroup>
          </Target>
        </Project>
        EOF
        export CustomBeforeDirectoryBuildProps="/tmp/CustomBeforeDirectoryBuildProps.props"
        cat >"${CustomBeforeDirectoryBuildProps}" <<'EOF'
        <Project>
          <PropertyGroup Condition="'$(PublishProfile)' == 'OpenShiftContainer'">
            <PublishProfileFullPath>/tmp/OpenShiftContainer.pubxml</PublishProfileFullPath>
          </PropertyGroup>
        </Project>
        EOF

        $(params.SCRIPT)
